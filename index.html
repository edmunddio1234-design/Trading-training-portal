<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Impact Trading Academy</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
  :root {
    --bg-primary: #F0F5F3;
    --bg-secondary: #FFFFFF;
    --bg-card: #F7FAF9;
    --bg-hover: #E8F0ED;
    --accent: #0D9373;
    --accent-light: #10B981;
    --accent-dark: #0B7A60;
    --green: #10B981;
    --green-dark: #0D9373;
    --red: #EF4444;
    --blue: #0D9373;
    --navy: #1B2A4A;
    --text-primary: #1B2A4A;
    --text-secondary: #374151;
    --text-muted: #6B7280;
    --border: #E5E7EB;
    --border-light: #D1D5DB;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Inter', 'Segoe UI', system-ui, sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg-primary); }
  ::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 3px; }
  .app-container { display: flex; min-height: 100vh; }
  .sidebar { width: 300px; background: var(--bg-secondary); border-right: 1px solid var(--border); display: flex; flex-direction: column; position: fixed; height: 100vh; overflow-y: auto; z-index: 100; transition: transform 0.3s ease; }
  .sidebar.collapsed { transform: translateX(-300px); }
  .sidebar-header { padding: 24px 20px; border-bottom: 1px solid var(--border); background: var(--navy); }
  .sidebar-header h1 { font-size: 18px; color: #FFFFFF; font-weight: 700; letter-spacing: -0.3px; }
  .sidebar-header h1 span { color: var(--accent-light); }
  .sidebar-header p { font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 4px; }
  .nav-section { padding: 12px 0; flex: 1; overflow-y: auto; }
  .nav-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); padding: 8px 20px; font-weight: 600; }
  .nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 20px; cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent; font-size: 13px; color: var(--text-secondary); }
  .nav-item:hover { background: var(--bg-hover); color: var(--text-primary); }
  .nav-item.active { background: rgba(13,147,115,0.08); border-left-color: var(--accent); color: var(--accent); }
  .nav-item.completed .nav-dot { background: var(--green); }
  .nav-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--border-light); flex-shrink: 0; }
  .nav-item.active .nav-dot { background: var(--accent); box-shadow: 0 0 8px rgba(13,147,115,0.4); }
  .progress-bar-container { padding: 16px 20px; border-top: 1px solid var(--border); }
  .progress-label { font-size: 11px; color: var(--text-muted); margin-bottom: 8px; display: flex; justify-content: space-between; }
  .progress-track { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
  .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent-light)); border-radius: 2px; transition: width 0.5s ease; }
  .main-content { flex: 1; margin-left: 300px; transition: margin-left 0.3s ease; }
  .main-content.expanded { margin-left: 0; }
  .content-header { padding: 16px 40px; border-bottom: 1px solid var(--border); background: var(--bg-secondary); display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 50; }
  .toggle-btn { background: none; border: 1px solid var(--border-light); color: var(--text-muted); padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px; }
  .toggle-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
  .header-actions { display: flex; gap: 8px; }
  .header-actions button { background: none; border: 1px solid var(--border-light); color: var(--text-secondary); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 6px; }
  .header-actions button:hover { background: var(--bg-hover); color: var(--text-primary); }
  .header-actions button.primary { background: var(--accent); border-color: var(--accent); color: #FFF; font-weight: 600; }
  .header-actions button.primary:hover { background: var(--accent-dark); }
  .content-body { padding: 40px; max-width: 920px; }
  .module-badge { display: inline-block; background: rgba(13,147,115,0.12); color: var(--accent); font-size: 11px; font-weight: 600; padding: 4px 12px; border-radius: 20px; letter-spacing: 0.5px; text-transform: uppercase; margin-bottom: 12px; }
  .module-title { font-size: 32px; font-weight: 800; line-height: 1.2; margin-bottom: 8px; letter-spacing: -0.5px; color: var(--navy); }
  .module-subtitle { font-size: 15px; color: var(--text-muted); margin-bottom: 32px; line-height: 1.5; }
  .lesson-section { margin-bottom: 28px; }
  .lesson-section h3 { font-size: 18px; font-weight: 700; color: var(--navy); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
  .lesson-section h3::before { content: ''; width: 3px; height: 18px; background: var(--accent); border-radius: 2px; }
  .lesson-section p { font-size: 15px; line-height: 1.75; color: var(--text-secondary); margin-bottom: 12px; }
  .lesson-section ul { list-style: none; padding: 0; }
  .lesson-section ul li { padding: 6px 0 6px 24px; position: relative; font-size: 14px; color: var(--text-secondary); line-height: 1.6; }
  .lesson-section ul li::before { content: '\25B8'; position: absolute; left: 4px; color: var(--accent); }
  .key-concept { background: linear-gradient(135deg, rgba(13,147,115,0.08), rgba(13,147,115,0.02)); border: 1px solid rgba(13,147,115,0.2); border-radius: 12px; padding: 20px 24px; margin: 16px 0; }
  .key-concept .label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--accent); font-weight: 600; margin-bottom: 8px; }
  .key-concept p { font-size: 14px; color: var(--text-primary); line-height: 1.6; margin: 0; }
  .resource-card { display: flex; align-items: center; gap: 16px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 16px 20px; margin: 12px 0; text-decoration: none; color: inherit; transition: all 0.2s; }
  .resource-card:hover { border-color: var(--accent); box-shadow: 0 4px 16px rgba(0,0,0,0.06); transform: translateY(-1px); }
  .resource-icon { width: 44px; height: 44px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
  .resource-icon.learn { background: rgba(13,147,115,0.1); }
  .resource-icon.chart { background: rgba(27,42,74,0.08); }
  .resource-icon.video { background: rgba(239,68,68,0.08); }
  .resource-icon.tool { background: rgba(245,165,36,0.1); }
  .resource-info h4 { font-size: 14px; font-weight: 600; color: var(--navy); margin-bottom: 2px; }
  .resource-info p { font-size: 12px; color: var(--text-muted); margin: 0; line-height: 1.4; }
  .resource-arrow { color: var(--border-light); font-size: 18px; margin-left: auto; }
  .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin: 16px 0; }
  .stat-box { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px; padding: 16px; text-align: center; }
  .stat-box .num { font-size: 24px; font-weight: 800; color: var(--accent); }
  .stat-box .lbl { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }
  .comparison-table { width: 100%; border-collapse: separate; border-spacing: 0; border-radius: 12px; overflow: hidden; margin: 16px 0; border: 1px solid var(--border); }
  .comparison-table th { background: var(--navy); padding: 12px 16px; text-align: left; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: #FFF; font-weight: 600; border-bottom: 1px solid var(--border); }
  .comparison-table td { padding: 10px 16px; font-size: 13px; color: var(--text-secondary); border-bottom: 1px solid var(--border); background: var(--bg-secondary); }
  .comparison-table tr:last-child td { border-bottom: none; }
  .comparison-table tr:hover td { background: rgba(13,147,115,0.03); }
  .quiz-container { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 16px; padding: 32px; margin-top: 40px; }
  .quiz-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
  .quiz-header h3 { font-size: 18px; color: var(--navy); font-weight: 700; }
  .quiz-score { font-size: 13px; color: var(--text-muted); }
  .quiz-question { font-size: 16px; font-weight: 500; margin-bottom: 16px; line-height: 1.5; color: var(--navy); }
  .quiz-progress { font-size: 12px; color: var(--text-muted); margin-bottom: 8px; }
  .quiz-option { display: block; width: 100%; text-align: left; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 14px 18px; margin-bottom: 8px; font-size: 14px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; font-family: inherit; }
  .quiz-option:hover:not(.selected):not(.correct):not(.incorrect) { border-color: var(--accent); color: var(--text-primary); background: var(--bg-hover); }
  .quiz-option.selected { border-color: var(--accent); background: rgba(13,147,115,0.08); color: var(--text-primary); }
  .quiz-option.correct { border-color: var(--green); background: rgba(16,185,129,0.1); color: var(--green-dark); }
  .quiz-option.incorrect { border-color: var(--red); background: rgba(239,68,68,0.06); color: var(--red); }
  .quiz-feedback { margin-top: 16px; padding: 16px; border-radius: 10px; font-size: 14px; line-height: 1.5; }
  .quiz-feedback.correct { background: rgba(16,185,129,0.08); border: 1px solid rgba(16,185,129,0.25); color: var(--green-dark); }
  .quiz-feedback.incorrect { background: rgba(239,68,68,0.06); border: 1px solid rgba(239,68,68,0.2); color: var(--red); }
  .quiz-btn { background: var(--accent); color: #FFF; border: none; padding: 10px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; margin-top: 16px; font-family: inherit; }
  .quiz-btn:hover { background: var(--accent-dark); }
  .quiz-btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
  .modal { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 16px; width: 90%; max-width: 800px; max-height: 85vh; overflow-y: auto; }
  .modal-header { padding: 24px 28px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
  .modal-header h2 { font-size: 20px; font-weight: 700; color: var(--navy); }
  .modal-close { background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer; }
  .modal-body { padding: 28px; }
  .form-group { margin-bottom: 20px; }
  .form-group label { display: block; font-size: 13px; font-weight: 500; color: var(--text-secondary); margin-bottom: 6px; }
  .form-group input, .form-group textarea, .form-group select { width: 100%; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; font-size: 14px; color: var(--text-primary); font-family: inherit; resize: vertical; }
  .form-group input:focus, .form-group textarea:focus { outline: none; border-color: var(--accent); }
  .form-group textarea { min-height: 100px; }
  .section-editor { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; margin-bottom: 12px; }
  .section-editor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .remove-btn { background: none; border: none; color: var(--red); cursor: pointer; font-size: 13px; }
  .add-btn { background: none; border: 1px dashed var(--border-light); color: var(--text-muted); padding: 10px; border-radius: 8px; width: 100%; cursor: pointer; font-size: 13px; margin-bottom: 16px; }
  .add-btn:hover { border-color: var(--accent); color: var(--accent); }
  .quiz-editor { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; margin-bottom: 12px; }
  .option-row { display: flex; gap: 8px; align-items: center; margin-bottom: 6px; }
  .option-row input[type="text"] { flex: 1; }
  .option-row input[type="radio"] { accent-color: var(--accent); }
  .modal-footer { padding: 20px 28px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; }
  .modal-footer button { padding: 10px 24px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; border: none; font-family: inherit; }
  .btn-cancel { background: var(--bg-hover); color: var(--text-secondary); }
  .btn-save { background: var(--accent); color: #FFF; font-weight: 600; }
  .btn-delete { background: var(--red); color: white; }
  .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 24px; }
  .dash-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 14px; padding: 24px; cursor: pointer; transition: all 0.3s; }
  .dash-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 8px 30px rgba(0,0,0,0.06); }
  .dash-card-num { font-size: 12px; color: var(--green); font-weight: 600; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; }
  .dash-card h3 { font-size: 16px; font-weight: 700; margin-bottom: 8px; line-height: 1.3; color: var(--navy); }
  .dash-card p { font-size: 13px; color: var(--text-muted); line-height: 1.5; }
  .dash-card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--border); }
  .dash-card-footer span { font-size: 12px; color: var(--text-muted); }
  .status-badge { font-size: 11px; padding: 3px 10px; border-radius: 12px; font-weight: 500; }
  .status-badge.not-started { background: rgba(100,116,139,0.1); color: var(--text-muted); }
  .status-badge.in-progress { background: rgba(13,147,115,0.1); color: var(--accent); }
  .status-badge.completed { background: rgba(16,185,129,0.12); color: var(--green-dark); }
  .hero-banner { background: linear-gradient(135deg, var(--navy) 0%, #243B60 100%); border-radius: 16px; padding: 40px; margin-bottom: 32px; color: white; }
  .hero-banner h2 { font-size: 28px; font-weight: 800; margin-bottom: 8px; }
  .hero-banner h2 span { color: var(--accent-light); }
  .hero-banner p { color: rgba(255,255,255,0.7); font-size: 15px; }
  .hero-stats { display: flex; gap: 32px; margin-top: 20px; }
  .hero-stat .val { font-size: 28px; font-weight: 800; color: var(--accent-light); }
  .hero-stat .desc { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: rgba(255,255,255,0.5); }

  /* AI Visual Generator Styles */
  .ai-visual-container { margin: 16px 0; border-radius: 12px; overflow: hidden; border: 1px solid var(--border); background: var(--bg-card); }
  .ai-visual-img { width: 100%; display: block; border-radius: 12px 12px 0 0; }
  .ai-visual-actions { display: flex; gap: 8px; padding: 12px 16px; align-items: center; border-top: 1px solid var(--border); }
  .ai-visual-btn { display: inline-flex; align-items: center; gap: 6px; background: linear-gradient(135deg, var(--navy), #2d4a7a); color: #FFF; border: none; padding: 10px 20px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.3s; }
  .ai-visual-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(27,42,74,0.3); }
  .ai-visual-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
  .ai-visual-btn.regenerate { background: var(--bg-hover); color: var(--text-secondary); border: 1px solid var(--border); }
  .ai-visual-btn.regenerate:hover { border-color: var(--accent); color: var(--accent); }
  .ai-visual-loading { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; gap: 16px; background: linear-gradient(135deg, rgba(27,42,74,0.04), rgba(13,147,115,0.04)); }
  .ai-visual-loading .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .ai-visual-loading p { font-size: 13px; color: var(--text-muted); }
  .ai-visual-error { padding: 16px; background: rgba(239,68,68,0.06); border: 1px solid rgba(239,68,68,0.2); border-radius: 8px; margin: 12px 0; color: var(--red); font-size: 13px; }
  .generate-all-btn { display: inline-flex; align-items: center; gap: 8px; background: linear-gradient(135deg, var(--accent), var(--accent-dark)); color: #FFF; border: none; padding: 12px 24px; border-radius: 10px; font-size: 14px; font-weight: 700; cursor: pointer; font-family: inherit; margin-bottom: 24px; transition: all 0.3s; box-shadow: 0 2px 12px rgba(13,147,115,0.2); }
  .generate-all-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(13,147,115,0.35); }
  .generate-all-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

  /* Settings Modal */
  .settings-section { margin-bottom: 24px; }
  .settings-section h4 { font-size: 14px; font-weight: 700; color: var(--navy); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
  .settings-info { font-size: 12px; color: var(--text-muted); line-height: 1.5; margin-top: 6px; }
  .api-key-row { display: flex; gap: 8px; }
  .api-key-row input { flex: 1; }
  .api-key-row button { white-space: nowrap; background: var(--accent); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; }
  .api-status { display: inline-flex; align-items: center; gap: 6px; font-size: 12px; margin-top: 8px; padding: 4px 10px; border-radius: 12px; }
  .api-status.connected { background: rgba(16,185,129,0.1); color: var(--green-dark); }
  .api-status.disconnected { background: rgba(239,68,68,0.08); color: var(--red); }

  /* Toast Notifications */
  .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 2000; display: flex; flex-direction: column; gap: 8px; }
  .toast { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px; padding: 14px 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.12); font-size: 13px; display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s ease; max-width: 360px; }
  .toast.success { border-left: 3px solid var(--green); }
  .toast.error { border-left: 3px solid var(--red); }
  .toast.info { border-left: 3px solid var(--accent); }
  @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

  /* Loading skeleton */
  .loading-screen { display: flex; align-items: center; justify-content: center; min-height: 60vh; flex-direction: column; gap: 16px; }
  .loading-screen .spinner { width: 48px; height: 48px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }

  @media (max-width: 768px) {
    .sidebar { transform: translateX(-300px); }
    .sidebar.open { transform: translateX(0); }
    .main-content { margin-left: 0 !important; }
    .content-body { padding: 24px 20px; }
    .module-title { font-size: 24px; }
    .dashboard-grid { grid-template-columns: 1fr; }
    .hero-banner { padding: 24px; }
    .hero-stats { flex-wrap: wrap; gap: 16px; }
  }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useMemo, useCallback, useRef } = React;

// =============================================================================
// API LAYER ‚Äî All data persists through the backend
// =============================================================================

const API = {
  async getModules() {
    const res = await fetch('/api/modules');
    return res.json();
  },
  async saveModules(modules) {
    const res = await fetch('/api/modules', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(modules) });
    return res.json();
  },
  async addModule(mod) {
    const res = await fetch('/api/modules', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(mod) });
    return res.json();
  },
  async updateModule(id, mod) {
    const res = await fetch(`/api/modules/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(mod) });
    return res.json();
  },
  async deleteModule(id) {
    const res = await fetch(`/api/modules/${id}`, { method: 'DELETE' });
    return res.json();
  },
  async getProgress() {
    const res = await fetch('/api/progress');
    return res.json();
  },
  async saveProgress(progress) {
    const res = await fetch('/api/progress', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(progress) });
    return res.json();
  },
  async getSettings() {
    const res = await fetch('/api/settings');
    return res.json();
  },
  async saveSettings(settings) {
    const res = await fetch('/api/settings', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(settings) });
    return res.json();
  },
  async generateVisual(params) {
    const res = await fetch('/api/generate-visual', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(params) });
    return res.json();
  },
  async regenerateVisual(params) {
    const res = await fetch('/api/regenerate-visual', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(params) });
    return res.json();
  },
  async generateModuleVisuals(moduleId) {
    const res = await fetch('/api/generate-module-visuals', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ moduleId }) });
    return res.json();
  }
};

// =============================================================================
// TOAST SYSTEM
// =============================================================================

function ToastContainer({ toasts }) {
  return (
    <div className="toast-container">
      {toasts.map(t => (
        <div key={t.id} className={`toast ${t.type}`}>
          <span>{t.type === 'success' ? '‚úì' : t.type === 'error' ? '‚úó' : '‚Ñπ'}</span>
          <span>{t.message}</span>
        </div>
      ))}
    </div>
  );
}

// =============================================================================
// AI VISUAL COMPONENT
// =============================================================================

function AIVisual({ moduleId, moduleTitle, sectionIndex, sectionTitle, sectionContent }) {
  const [imageUrl, setImageUrl] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [checked, setChecked] = useState(false);

  // Check if a cached image exists on mount
  useEffect(() => {
    if (!checked) {
      setChecked(true);
      fetch('/api/generate-visual', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ moduleId, sectionIndex, sectionTitle, sectionContent, moduleTitle })
      }).then(r => r.json()).then(data => {
        if (data.success && data.cached) {
          setImageUrl(data.imageUrl + '?t=' + Date.now());
        }
      }).catch(() => {});
    }
  }, [moduleId, sectionIndex]);

  const generate = async (regenerate = false) => {
    setLoading(true);
    setError(null);
    try {
      const endpoint = regenerate ? '/api/regenerate-visual' : '/api/generate-visual';
      const res = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ moduleId, sectionIndex, sectionTitle, sectionContent, moduleTitle })
      });
      const data = await res.json();
      if (data.success) {
        setImageUrl(data.imageUrl + '?t=' + Date.now());
      } else {
        setError(data.error || 'Failed to generate visual');
      }
    } catch (err) {
      setError(err.message);
    }
    setLoading(false);
  };

  if (loading) {
    return (
      <div className="ai-visual-container">
        <div className="ai-visual-loading">
          <div className="spinner" />
          <p>Generating AI visual for "{sectionTitle}"...</p>
        </div>
      </div>
    );
  }

  if (imageUrl) {
    return (
      <div className="ai-visual-container">
        <img className="ai-visual-img" src={imageUrl} alt={`AI visual for ${sectionTitle}`} />
        <div className="ai-visual-actions">
          <button className="ai-visual-btn regenerate" onClick={() => generate(true)}>‚Üª Regenerate</button>
        </div>
      </div>
    );
  }

  return (
    <div style={{margin: '12px 0'}}>
      <button className="ai-visual-btn" onClick={() => generate(false)}>
        ‚ú¶ Generate AI Visual
      </button>
      {error && <div className="ai-visual-error">{error}</div>}
    </div>
  );
}

// =============================================================================
// MAIN APP
// =============================================================================

function App() {
  const [modules, setModules] = useState([]);
  const [currentView, setCurrentView] = useState('dashboard');
  const [currentModuleId, setCurrentModuleId] = useState(null);
  const [completedModules, setCompletedModules] = useState({});
  const [quizState, setQuizState] = useState({});
  const [showAdmin, setShowAdmin] = useState(false);
  const [showSettings, setShowSettings] = useState(false);
  const [editingModule, setEditingModule] = useState(null);
  const [sidebarOpen, setSidebarOpen] = useState(true);
  const [loading, setLoading] = useState(true);
  const [toasts, setToasts] = useState([]);

  const addToast = (message, type = 'info') => {
    const id = Date.now();
    setToasts(prev => [...prev, { id, message, type }]);
    setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 4000);
  };

  // Load data from backend on mount
  useEffect(() => {
    async function load() {
      try {
        const [mods, prog] = await Promise.all([API.getModules(), API.getProgress()]);
        setModules(mods);
        setCompletedModules(prog.completedModules || {});
        setQuizState(prog.quizState || {});
      } catch (err) {
        addToast('Failed to load data: ' + err.message, 'error');
      }
      setLoading(false);
    }
    load();
  }, []);

  // Auto-save progress when it changes
  const progressSaveTimeout = useRef(null);
  useEffect(() => {
    if (loading) return;
    clearTimeout(progressSaveTimeout.current);
    progressSaveTimeout.current = setTimeout(() => {
      API.saveProgress({ completedModules, quizState }).catch(() => {});
    }, 1000);
  }, [completedModules, quizState, loading]);

  const progress = useMemo(() => {
    const done = Object.values(completedModules).filter(Boolean).length;
    return modules.length > 0 ? Math.round((done / modules.length) * 100) : 0;
  }, [modules, completedModules]);

  const currentModule = modules.find(m => m.id === currentModuleId);
  const openModule = (id) => { setCurrentModuleId(id); setCurrentView('module'); };
  const goToDashboard = () => { setCurrentView('dashboard'); setCurrentModuleId(null); };
  const completeModule = (id) => setCompletedModules(prev => ({...prev, [id]: true}));

  const openAdminNew = () => {
    setEditingModule({ id: 'm' + Date.now(), title: '', subtitle: '', sections: [{ title: '', content: '', type: 'text' }], quiz: [{ question: '', options: ['','','',''], correct: 0, explanation: '' }] });
    setShowAdmin(true);
  };
  const openAdminEdit = (mod) => { setEditingModule(JSON.parse(JSON.stringify(mod))); setShowAdmin(true); };

  const saveModule = async (mod) => {
    const isNew = !modules.find(m => m.id === mod.id);
    if (isNew) {
      setModules(prev => [...prev, mod]);
      await API.addModule(mod).catch(() => {});
    } else {
      setModules(prev => { const n = [...prev]; const idx = n.findIndex(m => m.id === mod.id); if (idx >= 0) n[idx] = mod; return n; });
      await API.updateModule(mod.id, mod).catch(() => {});
    }
    setShowAdmin(false);
    setEditingModule(null);
    addToast(isNew ? 'Module created!' : 'Module saved!', 'success');
  };

  const deleteModule = async (id) => {
    setModules(prev => prev.filter(m => m.id !== id));
    await API.deleteModule(id).catch(() => {});
    if (currentModuleId === id) goToDashboard();
    setShowAdmin(false);
    setEditingModule(null);
    addToast('Module deleted', 'info');
  };

  if (loading) {
    return (
      <div className="loading-screen">
        <div className="spinner" />
        <p style={{color: 'var(--text-muted)', fontSize: 14}}>Loading Impact Trading Academy...</p>
      </div>
    );
  }

  return (
    <div className="app-container">
      <div className={`sidebar ${!sidebarOpen ? 'collapsed' : ''}`}>
        <div className="sidebar-header" onClick={goToDashboard} style={{cursor:'pointer'}}>
          <h1>IMPACT <span>TRADING</span> ACADEMY</h1>
          <p>Powered by Mission Metrics</p>
        </div>
        <div className="nav-section">
          <div className="nav-label">Training Modules</div>
          {modules.map((m, i) => (
            <div key={m.id} className={`nav-item ${currentModuleId === m.id ? 'active' : ''} ${completedModules[m.id] ? 'completed' : ''}`} onClick={() => openModule(m.id)}>
              <div className="nav-dot" />
              <span>{i + 1}. {m.title.length > 30 ? m.title.slice(0, 30) + '‚Ä¶' : m.title}</span>
            </div>
          ))}
        </div>
        <div className="progress-bar-container">
          <div className="progress-label"><span>Overall Progress</span><span>{progress}%</span></div>
          <div className="progress-track"><div className="progress-fill" style={{width: `${progress}%`}} /></div>
        </div>
      </div>
      <div className={`main-content ${!sidebarOpen ? 'expanded' : ''}`}>
        <div className="content-header">
          <button className="toggle-btn" onClick={() => setSidebarOpen(!sidebarOpen)}>{sidebarOpen ? '‚óÄ' : '‚ñ∂'} Menu</button>
          <div className="header-actions">
            <button onClick={goToDashboard}>‚óà Dashboard</button>
            <button onClick={() => setShowSettings(true)}>‚öô Settings</button>
            <button className="primary" onClick={openAdminNew}>+ Add Module</button>
          </div>
        </div>
        <div className="content-body">
          {currentView === 'dashboard' && <Dashboard modules={modules} completedModules={completedModules} progress={progress} onOpen={openModule} onEdit={openAdminEdit} />}
          {currentView === 'module' && currentModule && <ModuleView module={currentModule} modules={modules} quizState={quizState} setQuizState={setQuizState} onComplete={() => completeModule(currentModule.id)} isCompleted={completedModules[currentModule.id]} onEdit={() => openAdminEdit(currentModule)} onNext={() => { const idx = modules.findIndex(m => m.id === currentModule.id); if (idx < modules.length - 1) openModule(modules[idx + 1].id); }} hasNext={modules.findIndex(m => m.id === currentModule.id) < modules.length - 1} addToast={addToast} />}
        </div>
      </div>
      {showAdmin && editingModule && <AdminModal module={editingModule} onSave={saveModule} onDelete={deleteModule} onClose={() => { setShowAdmin(false); setEditingModule(null); }} isNew={!modules.find(m => m.id === editingModule.id)} />}
      {showSettings && <SettingsModal onClose={() => setShowSettings(false)} addToast={addToast} />}
      <ToastContainer toasts={toasts} />
    </div>
  );
}

// =============================================================================
// DASHBOARD
// =============================================================================

function Dashboard({ modules, completedModules, progress, onOpen }) {
  const completed = Object.values(completedModules).filter(Boolean).length;
  return (
    <div>
      <div className="hero-banner">
        <h2>See Your Impact. <span>Grow Your Mission.</span></h2>
        <p>Track your progress through the complete foundations of trading, risk management, and asset leverage.</p>
        <div className="hero-stats">
          <div className="hero-stat"><div className="val">{modules.length}</div><div className="desc">Total Modules</div></div>
          <div className="hero-stat"><div className="val">{completed}</div><div className="desc">Completed</div></div>
          <div className="hero-stat"><div className="val">{progress}%</div><div className="desc">Progress</div></div>
          <div className="hero-stat"><div className="val">{modules.reduce((a,m) => a + (m.quiz?.length||0), 0)}</div><div className="desc">Quiz Questions</div></div>
        </div>
      </div>
      <div className="dashboard-grid">
        {modules.map((m, i) => {
          const status = completedModules[m.id] ? 'completed' : 'in-progress';
          return (
            <div key={m.id} className="dash-card" onClick={() => onOpen(m.id)}>
              <div className="dash-card-num">Module {i + 1}</div>
              <h3>{m.title}</h3>
              <p>{m.subtitle}</p>
              <div className="dash-card-footer">
                <span>{m.sections?.filter(s=>s.type!=='resources').length || 0} lessons ¬∑ {m.quiz?.length || 0} questions</span>
                <span className={`status-badge ${status}`}>{status === 'completed' ? '‚úì Done' : 'Available'}</span>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}

// =============================================================================
// MODULE VIEW (with AI visuals per section)
// =============================================================================

function ModuleView({ module, modules, quizState, setQuizState, onComplete, isCompleted, onEdit, onNext, hasNext, addToast }) {
  const moduleIndex = modules.findIndex(m => m.id === module.id);
  const mQuiz = quizState[module.id] || { current: 0, answers: {}, submitted: {} };
  const quiz = module.quiz || [];
  const q = quiz[mQuiz.current];
  const allAnswered = Object.keys(mQuiz.submitted).length === quiz.length;
  const correctCount = Object.entries(mQuiz.submitted).filter(([,v]) => v).length;
  const [generatingAll, setGeneratingAll] = useState(false);

  const selectAnswer = (qi, oi) => { if (mQuiz.submitted[qi] !== undefined) return; setQuizState(p => ({...p, [module.id]: {...mQuiz, answers: {...mQuiz.answers, [qi]: oi}}})); };
  const submitAnswer = (qi) => { const ok = mQuiz.answers[qi] === quiz[qi].correct; setQuizState(p => ({...p, [module.id]: {...mQuiz, submitted: {...mQuiz.submitted, [qi]: ok}}})); };
  const nextQuestion = () => { if (mQuiz.current < quiz.length - 1) setQuizState(p => ({...p, [module.id]: {...mQuiz, current: mQuiz.current + 1}})); };
  const resetQuiz = () => setQuizState(p => ({...p, [module.id]: { current: 0, answers: {}, submitted: {} }}));

  const generateAllVisuals = async () => {
    setGeneratingAll(true);
    addToast('Generating visuals for all sections... This may take a minute.', 'info');
    try {
      const result = await API.generateModuleVisuals(module.id);
      if (result.success) {
        const successCount = result.results.filter(r => r.imageUrl).length;
        addToast(`Generated ${successCount} visuals!`, 'success');
        // Force re-render by navigating away and back
        window.location.reload();
      }
    } catch (err) {
      addToast('Error generating visuals: ' + err.message, 'error');
    }
    setGeneratingAll(false);
  };

  return (
    <div>
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start'}}>
        <div>
          <div className="module-badge">Module {moduleIndex + 1} of {modules.length}</div>
          <h2 className="module-title">{module.title}</h2>
          <p className="module-subtitle">{module.subtitle}</p>
        </div>
        <button onClick={onEdit} style={{background:'none',border:'1px solid var(--border-light)',color:'var(--text-muted)',padding:'6px 14px',borderRadius:6,cursor:'pointer',fontSize:12,whiteSpace:'nowrap',marginTop:8}}>‚úé Edit</button>
      </div>

      <button className="generate-all-btn" onClick={generateAllVisuals} disabled={generatingAll}>
        {generatingAll ? '‚ü≥ Generating...' : '‚ú¶ Generate All AI Visuals'}
      </button>

      {module.sections?.map((s, i) => {
        if (s.type === 'stats') return (
          <div key={i} className="lesson-section">
            <h3>{s.title}</h3>
            <div className="stat-grid">
              {s.stats.map((st, si) => <div key={si} className="stat-box"><div className="num">{st.num}</div><div className="lbl">{st.lbl}</div></div>)}
            </div>
          </div>
        );
        if (s.type === 'table') return (
          <div key={i} className="lesson-section">
            <h3>{s.title}</h3>
            <table className="comparison-table">
              <thead><tr>{s.headers.map((h,hi) => <th key={hi}>{h}</th>)}</tr></thead>
              <tbody>{s.rows.map((r,ri) => <tr key={ri}>{r.map((c,ci) => <td key={ci}>{c}</td>)}</tr>)}</tbody>
            </table>
          </div>
        );
        if (s.type === 'resources') return (
          <div key={i} className="lesson-section">
            <h3>{s.title || 'Visual Resources & Further Reading'}</h3>
            {s.resources.map((r, ri) => (
              <a key={ri} className="resource-card" href={r.url} target="_blank" rel="noopener noreferrer">
                <div className={`resource-icon ${r.icon}`}>{r.icon === 'learn' ? 'üìö' : r.icon === 'chart' ? 'üìà' : r.icon === 'video' ? 'üé¨' : 'üîß'}</div>
                <div className="resource-info"><h4>{r.title}</h4><p>{r.desc}</p></div>
                <div className="resource-arrow">‚Üí</div>
              </a>
            ))}
          </div>
        );
        // TEXT sections ‚Äî these get AI visual buttons
        return (
          <div key={i} className="lesson-section">
            <h3>{s.title}</h3>
            {s.content.split('\n\n').map((para, pi) => <p key={pi}>{para}</p>)}
            <AIVisual
              moduleId={module.id}
              moduleTitle={module.title}
              sectionIndex={i}
              sectionTitle={s.title}
              sectionContent={s.content}
            />
          </div>
        );
      })}

      {quiz.length > 0 && (
        <div className="quiz-container">
          <div className="quiz-header"><h3>üìù Knowledge Check</h3><span className="quiz-score">{allAnswered ? `Score: ${correctCount}/${quiz.length} (${Math.round(correctCount/quiz.length*100)}%)` : `${Object.keys(mQuiz.submitted).length}/${quiz.length} answered`}</span></div>
          {!allAnswered && q && (
            <div>
              <div className="quiz-progress">Question {mQuiz.current + 1} of {quiz.length}</div>
              <div className="quiz-question">{q.question}</div>
              {q.options.map((opt, oi) => {
                let cls = 'quiz-option';
                if (mQuiz.submitted[mQuiz.current] !== undefined) { if (oi === q.correct) cls += ' correct'; else if (oi === mQuiz.answers[mQuiz.current] && oi !== q.correct) cls += ' incorrect'; }
                else if (mQuiz.answers[mQuiz.current] === oi) cls += ' selected';
                return <button key={oi} className={cls} onClick={() => selectAnswer(mQuiz.current, oi)}>{opt}</button>;
              })}
              {mQuiz.submitted[mQuiz.current] !== undefined && <div className={`quiz-feedback ${mQuiz.submitted[mQuiz.current] ? 'correct' : 'incorrect'}`}>{mQuiz.submitted[mQuiz.current] ? '‚úì Correct! ' : '‚úó Incorrect. '}{q.explanation}</div>}
              <div style={{display:'flex',gap:8,marginTop:16}}>
                {mQuiz.submitted[mQuiz.current] === undefined && <button className="quiz-btn" disabled={mQuiz.answers[mQuiz.current] === undefined} onClick={() => submitAnswer(mQuiz.current)}>Submit Answer</button>}
                {mQuiz.submitted[mQuiz.current] !== undefined && mQuiz.current < quiz.length - 1 && <button className="quiz-btn" onClick={nextQuestion}>Next Question ‚Üí</button>}
              </div>
            </div>
          )}
          {allAnswered && (
            <div style={{textAlign:'center',padding:'20px 0'}}>
              <div style={{fontSize:48,marginBottom:12}}>{correctCount === quiz.length ? 'üèÜ' : correctCount >= quiz.length * 0.7 ? 'üëç' : 'üìö'}</div>
              <div style={{fontSize:20,fontWeight:700,marginBottom:8,color:'var(--navy)'}}>{correctCount === quiz.length ? 'Perfect Score!' : correctCount >= quiz.length * 0.7 ? 'Great Job!' : 'Keep Studying!'}</div>
              <div style={{fontSize:14,color:'var(--text-muted)',marginBottom:20}}>You scored {correctCount} out of {quiz.length} ({Math.round(correctCount/quiz.length*100)}%)</div>
              <div style={{display:'flex',gap:8,justifyContent:'center',flexWrap:'wrap'}}>
                <button className="quiz-btn" onClick={resetQuiz} style={{background:'var(--bg-hover)',color:'var(--text-secondary)'}}>Retake Quiz</button>
                {!isCompleted && correctCount >= quiz.length * 0.7 && <button className="quiz-btn" onClick={onComplete}>‚úì Mark Complete</button>}
                {hasNext && <button className="quiz-btn" onClick={onNext}>Next Module ‚Üí</button>}
              </div>
            </div>
          )}
        </div>
      )}
      {isCompleted && <div style={{background:'rgba(16,185,129,0.08)',border:'1px solid rgba(16,185,129,0.25)',borderRadius:12,padding:20,marginTop:24,textAlign:'center'}}><span style={{color:'var(--green-dark)',fontSize:16,fontWeight:600}}>‚úì Module Completed</span></div>}
    </div>
  );
}

// =============================================================================
// ADMIN MODAL (same as before)
// =============================================================================

function AdminModal({ module, onSave, onDelete, onClose, isNew }) {
  const [form, setForm] = useState(module);
  const updateField = (f, v) => setForm(p => ({...p, [f]: v}));
  const updateSection = (idx, f, v) => { const s = [...form.sections]; s[idx] = {...s[idx], [f]: v}; setForm(p => ({...p, sections: s})); };
  const addSection = () => setForm(p => ({...p, sections: [...p.sections, {title:'', content:'', type:'text'}]}));
  const removeSection = (idx) => setForm(p => ({...p, sections: p.sections.filter((_,i) => i !== idx)}));
  const updateQuiz = (qi, f, v) => { const q = [...(form.quiz||[])]; q[qi] = {...q[qi], [f]: v}; setForm(p => ({...p, quiz: q})); };
  const updateQuizOption = (qi, oi, v) => { const q = [...(form.quiz||[])]; const o = [...q[qi].options]; o[oi] = v; q[qi] = {...q[qi], options: o}; setForm(p => ({...p, quiz: q})); };
  const addQuiz = () => setForm(p => ({...p, quiz: [...(p.quiz||[]), {question:'', options:['','','',''], correct:0, explanation:''}]}));
  const removeQuiz = (idx) => setForm(p => ({...p, quiz: (p.quiz||[]).filter((_,i) => i !== idx)}));

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={e => e.stopPropagation()}>
        <div className="modal-header"><h2>{isNew ? 'Add New Module' : 'Edit Module'}</h2><button className="modal-close" onClick={onClose}>√ó</button></div>
        <div className="modal-body">
          <div className="form-group"><label>Module Title</label><input value={form.title} onChange={e => updateField('title', e.target.value)} placeholder="e.g., Advanced Chart Patterns" /></div>
          <div className="form-group"><label>Subtitle / Description</label><input value={form.subtitle} onChange={e => updateField('subtitle', e.target.value)} placeholder="Brief description" /></div>
          <h3 style={{fontSize:15,fontWeight:700,margin:'24px 0 12px',color:'var(--navy)'}}>Lesson Sections</h3>
          {form.sections?.map((s, i) => (
            <div key={i} className="section-editor">
              <div className="section-editor-header"><span style={{fontSize:12,color:'var(--text-muted)'}}>Section {i + 1} ({s.type || 'text'})</span>{form.sections.length > 1 && <button className="remove-btn" onClick={() => removeSection(i)}>Remove</button>}</div>
              <div className="form-group" style={{marginBottom:8}}><input value={s.title} onChange={e => updateSection(i, 'title', e.target.value)} placeholder="Section title" /></div>
              <div className="form-group" style={{marginBottom:0}}><textarea value={s.content||''} onChange={e => updateSection(i, 'content', e.target.value)} placeholder="Section content..." rows={4} /></div>
            </div>
          ))}
          <button className="add-btn" onClick={addSection}>+ Add Section</button>
          <h3 style={{fontSize:15,fontWeight:700,margin:'24px 0 12px',color:'var(--navy)'}}>Quiz Questions</h3>
          {(form.quiz || []).map((q, qi) => (
            <div key={qi} className="quiz-editor">
              <div className="section-editor-header"><span style={{fontSize:12,color:'var(--text-muted)'}}>Question {qi + 1}</span><button className="remove-btn" onClick={() => removeQuiz(qi)}>Remove</button></div>
              <div className="form-group" style={{marginBottom:8}}><input value={q.question} onChange={e => updateQuiz(qi, 'question', e.target.value)} placeholder="Question text" /></div>
              {q.options.map((opt, oi) => (<div key={oi} className="option-row"><input type="radio" name={`c-${qi}`} checked={q.correct === oi} onChange={() => updateQuiz(qi, 'correct', oi)} /><input type="text" value={opt} onChange={e => updateQuizOption(qi, oi, e.target.value)} placeholder={`Option ${oi+1}`} /></div>))}
              <div className="form-group" style={{marginTop:8,marginBottom:0}}><input value={q.explanation||''} onChange={e => updateQuiz(qi, 'explanation', e.target.value)} placeholder="Explanation shown after answering" /></div>
            </div>
          ))}
          <button className="add-btn" onClick={addQuiz}>+ Add Question</button>
        </div>
        <div className="modal-footer">
          {!isNew && <button className="btn-delete" onClick={() => { if(confirm('Delete this module permanently?')) onDelete(form.id); }}>Delete Module</button>}
          <div style={{flex:1}} />
          <button className="btn-cancel" onClick={onClose}>Cancel</button>
          <button className="btn-save" onClick={() => onSave(form)}>Save Module</button>
        </div>
      </div>
    </div>
  );
}

// =============================================================================
// SETTINGS MODAL
// =============================================================================

function SettingsModal({ onClose, addToast }) {
  const [apiKey, setApiKey] = useState('');
  const [hasKey, setHasKey] = useState(false);
  const [maskedKey, setMaskedKey] = useState('');
  const [saving, setSaving] = useState(false);

  useEffect(() => {
    API.getSettings().then(data => {
      setHasKey(data.hasKey);
      setMaskedKey(data.geminiApiKey || '');
    });
  }, []);

  const saveKey = async () => {
    if (!apiKey.trim()) return;
    setSaving(true);
    try {
      await API.saveSettings({ geminiApiKey: apiKey.trim() });
      setHasKey(true);
      setMaskedKey('‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + apiKey.trim().slice(-4));
      setApiKey('');
      addToast('API key saved successfully!', 'success');
    } catch (err) {
      addToast('Failed to save API key', 'error');
    }
    setSaving(false);
  };

  const clearKey = async () => {
    await API.saveSettings({ geminiApiKey: '' });
    setHasKey(false);
    setMaskedKey('');
    addToast('API key removed', 'info');
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal" onClick={e => e.stopPropagation()} style={{maxWidth: 560}}>
        <div className="modal-header"><h2>‚öô Settings</h2><button className="modal-close" onClick={onClose}>√ó</button></div>
        <div className="modal-body">
          <div className="settings-section">
            <h4>‚ú¶ AI Visual Generation</h4>
            <p style={{fontSize:13,color:'var(--text-muted)',marginBottom:16,lineHeight:1.6}}>
              Connect your Google Gemini API key to generate AI-powered visuals for each lesson section.
              Images are cached so you only pay once per section.
            </p>
            <div className="form-group">
              <label>Gemini API Key</label>
              {hasKey && (
                <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                  <span className="api-status connected">‚óè Connected</span>
                  <span style={{fontSize:12,color:'var(--text-muted)',fontFamily:'monospace'}}>{maskedKey}</span>
                  <button onClick={clearKey} style={{background:'none',border:'none',color:'var(--red)',cursor:'pointer',fontSize:12}}>Remove</button>
                </div>
              )}
              {!hasKey && <span className="api-status disconnected" style={{marginBottom:8,display:'inline-flex'}}>‚óè Not connected</span>}
              <div className="api-key-row">
                <input type="password" value={apiKey} onChange={e => setApiKey(e.target.value)} placeholder={hasKey ? 'Enter new key to replace' : 'Paste your Gemini API key'} />
                <button onClick={saveKey} disabled={saving || !apiKey.trim()}>{saving ? '...' : 'Save Key'}</button>
              </div>
              <div className="settings-info">
                Get your key at <a href="https://aistudio.google.com/apikey" target="_blank" rel="noopener noreferrer" style={{color:'var(--accent)'}}>aistudio.google.com/apikey</a>.
                Your key is stored securely on the server and never exposed to the browser.
              </div>
            </div>
          </div>
          <div className="settings-section">
            <h4>üíæ Data Persistence</h4>
            <p style={{fontSize:13,color:'var(--text-muted)',lineHeight:1.6}}>
              All modules, progress, quiz states, and generated images are automatically saved to the server.
              Your data persists across browser sessions and devices.
            </p>
          </div>
        </div>
        <div className="modal-footer">
          <button className="btn-cancel" onClick={onClose}>Close</button>
        </div>
      </div>
    </div>
  );
}

ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>
